<script>
/*jslint browser, devel, maxlen: 80, this*/
/*global google, jQuery, Sortable*/
(function (jQuery, google) {
    "use strict";

    const restaurants = (function ($) {
        const restaurantsObj = {
            "--TBD--": "https://www.google.com/",
            "BERTUCCI'S": "http://www.bertuccis.com/",
            "PAPA GINOS": "https://www.papaginos.com/menu"
        };

        function changeUrl() {
            $("form#newGroupOrder a").attr("href", restaurantsObj[this.value]);
        }

        function get() {
            return restaurantsObj;
        }

        return {
            changeUrl,
            get
        };

    }(jQuery));

    const orders = (function (google, $) {
        let ordersArr = [];
        let tableHtml = $("table").html();

        function add(newOrder) {
            ordersArr.push(newOrder);
        }

        function displayOrderTables(ordersJsonStr) {
            let ordersJson = JSON.parse(ordersJsonStr);
            ordersJson.restaurants.forEach(
                function (restaurant, tableX) {
                    $("dev#container").append(tableHtml);
                    $("table:eq(" + tableX + ")").attr("id","table" + tableX);
                    $("table:eq(" + tableX + " caption)").text(restaurant);
                    restaurant.orders.forEach(
                        function (order, index) {
                            let price = Number(order.price);
                            let tax = price * 0.07;
                            let total = price + tax;
                            $("table:eq(" + tableX + ") tbody").append(
                                "<tr>" +
                                "<td>" + index + "</td>" +
                                "<td>" + order.placer + "</td>" +
                                "<td>" + order.selection + "</td>" +
                                "<td>" +
                                price.toLocaleString(
                                    "en-US",
                                    {
                                        "type": "currency",
                                        "currency": "USD",
                                        "minimumFractionDigits": 2,
                                        "maximumFractionDigits": 2
                                    }
                                ) +
                                "</td>" +
                                "<td>" +
                                tax.toLocaleString(
                                    "en-US",
                                    {
                                        "type": "currency",
                                        "currency": "USD",
                                        "minimumFractionDigits": 2,
                                        "maximumFractionDigits": 2
                                    }
                                ) +
                                "</td>" +
                                "<td>" +
                                total.toLocaleString(
                                    "en-US",
                                    {
                                        "type": "currency",
                                        "currency": "USD",
                                        "minimumFractionDigits": 2,
                                        "maximumFractionDigits": 2
                                    }
                                ) +
                                "</td>" +
                                "</tr>"
                            );
                            $("table").show();
                        }
                    );
                }
            );
        }

        function display() {
            google.script.run
                .withSuccessHandler(displayOrderTables)
                .getOrders();
        }

        return {
            add,
            display
        };

    }(google, jQuery));

    const enterEdit = (function ($, google, orders, restaurants) {
        let formArr = [];
        let formObj = {};

        function formArrToObj(total, curVal) {
            total[curVal.name] = curVal.value;
            return total;
        }

        Object.keys(restaurants.get()).forEach(function (key) {
            $("select#restaurant").append(
                "<option>" + key + "</option>"
            );
        });

        function displayForm() {
            $(function () {
                $("button#newGroupOrder").hide();
                $("form#newGroupOrder").show();
                $("form#newGroupOrder").submit(function (event) {
                    event.preventDefault();
                    $("form#newGroupOrder").hide();
                    $("button#newGroupOrder").show();
                    formArr = $("form#newGroupOrder").serializeArray();
                    formObj = formArr.reduce(formArrToObj, {});
                    google.script.run
                        .withSuccessHandler(orders.display)
                        .fileOrderToSpreadsheet(formObj);
                });
                $("select#restaurant option").click(restaurants.changeUrl);
            });
        }

        return {
            displayForm
        };

    }(jQuery, google, orders, restaurants));

    //**************************************************************************

    function main(dataObj, $) {
        $("h2").text(dataObj.projectName);
        // TODO: if group orders, display them
        // ---group orders code goes here---
        $("button#newGroupOrder").click(enterEdit.displayForm);
    }

    //**************************************************************************

    jQuery(function startUp() {
        google.script.run
            .withSuccessHandler(main)
            .withUserObject(jQuery)
            .getData();
    });

}(jQuery, google));
</script>