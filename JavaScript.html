<script>
/*jslint browser, devel, maxlen: 80, this*/
/*global google, jQuery, Sortable*/
(function (jQuery, google) {
    "use strict";

    const user = (function () {
        let obj = {};

        function get() {
            return obj;
        }

        function set(userObj) {
            obj = userObj;
        }

        return {
            get,
            set
        };

    }());

    const restaurants = (function ($) {
        const restaurantsObj = {
            "--TBD--": "https://www.google.com/",
            "BERTUCCI'S": "http://www.bertuccis.com/",
            "PAPA GINOS": "https://www.papaginos.com/menu"
        };

        function changeUrl() {
            $("form#newGroupOrder a").attr("href", restaurantsObj[this.value]);
        }

        function get() {
            return restaurantsObj;
        }

        return {
            changeUrl,
            get
        };

    }(jQuery));

    const orders = (function (google, $) {
        let ordersArr = [];
        let tableHtml = $("div#tableHtml").html();

        function add(newOrder) {
            ordersArr.push(newOrder);
        }

        function displayOrderTables(tempJsonStr) {
            let tempJson = JSON.parse(tempJsonStr);
            let ordersJson = {};
            // [
            //   [date,userID,restaurant,placer,selection,
            //    price,"","",status,offset,""]
            // ]
            ordersJson = tempJson.orders.reduce(
                function (obj, curVal) {
                    let restaurant = curVal[2];
                    if (
                        obj[restaurant] === null ||
                        obj[restaurant] === undefined
                    ) {
                        obj[restaurant] = [];
                    }
                    obj[restaurant].push({
                        "placer": curVal[3],
                        "selection": curVal[4],
                        "price": curVal[5]
                    });
                    return obj;
                },
                {}
            );
            Object.keys(ordersJson).forEach(
                function (restaurant, tableX) {
                    $("div#table").append(tableHtml);
                    $("div#table table:eq(" + tableX + ")")
                        .attr("id", "table" + tableX);
                    $("div#table table:eq(" + tableX + ") caption")
                        .text(restaurant);
                    ordersJson[restaurant].forEach(
                        function (order, index) {
                            let price = Number(order.price);
                            let tax = price * 0.07;
                            let total = price + tax;
                            $("div#table table:eq(" + tableX + ") tbody")
                                .append(
                                    "<tr>" +
                                    "<td>" + (index + 1) + "</td>" +
                                    "<td>" + order.placer + "</td>" +
                                    "<td>" + order.selection + "</td>" +
                                    "<td>" +
                                    price.toLocaleString(
                                        "en-US",
                                        {
                                            "type": "currency",
                                            "currency": "USD",
                                            "minimumFractionDigits": 2,
                                            "maximumFractionDigits": 2
                                        }
                                    ) +
                                    "</td>" +
                                    "<td>" +
                                    tax.toLocaleString(
                                        "en-US",
                                        {
                                            "type": "currency",
                                            "currency": "USD",
                                            "minimumFractionDigits": 2,
                                            "maximumFractionDigits": 2
                                        }
                                    ) +
                                    "</td>" +
                                    "<td>" +
                                    total.toLocaleString(
                                        "en-US",
                                        {
                                            "type": "currency",
                                            "currency": "USD",
                                            "minimumFractionDigits": 2,
                                            "maximumFractionDigits": 2
                                        }
                                    ) +
                                    "</td>" +
                                    "</tr>"
                                );
                        }
                    );
                }
            );
            $("div#table").show();
        }

        function display() {
            google.script.run
                .withSuccessHandler(displayOrderTables)
                .getOrders();
        }

        return {
            add,
            display
        };

    }(google, jQuery));

    const enterEdit = (function ($, google, orders, restaurants, user) {
        let formArr = [];
        let formObj = {};

        function formArrToObj(total, curVal) {
            total[curVal.name] = curVal.value;
            return total;
        }

        Object.keys(restaurants.get()).forEach(function (key) {
            $("select#restaurant").append(
                "<option>" + key + "</option>"
            );
        });

        function displayForm() {
            $(function () {
                let userObj = user.get();
                $("button#newGroupOrder").hide();
                $("form#newGroupOrder").show();
                $("form#newGroupOrder input[name=\"userName\"]")
                    .val(
                        userObj.name.familyName + "," +
                        userObj.name.givenName
                    );
                $("form#newGroupOrder input[name=\"userId]\"")
                    .val(userObj.id);
                $("form#newGroupOrder").submit(function (event) {
                    event.preventDefault();
                    $("form#newGroupOrder").hide();
                    $("button#newGroupOrder").show();
                    formArr = $("form#newGroupOrder").serializeArray();
                    formObj = formArr.reduce(formArrToObj, {});
                    google.script.run
                        .withSuccessHandler(orders.display)
                        .fileOrderToSpreadsheet(formObj);
                });
                $("select#restaurant option").click(restaurants.changeUrl);
            });
        }

        return {
            displayForm
        };

    }(jQuery, google, orders, restaurants, user));


    //**************************************************************************

    function main(dataObj) {
        jQuery("h2").text(dataObj.projectName);
        user.set(dataObj.user);
        // TODO: if group orders, display them
        // ---group orders code goes here---
        jQuery("button#newGroupOrder").click(enterEdit.displayForm);
    }

    //**************************************************************************

    jQuery(function startUp() {
        google.script.run
            .withSuccessHandler(main)
            .getData();
    });

}(jQuery, google));
</script>